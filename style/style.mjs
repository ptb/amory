/*! @copyright Peter T Bosse II | @license MIT | @link github.com/ptb/amory/tree/master/style */import{prefix as e}from"./inline-style-prefixer.mjs";import{createPortal as t,h as r,PureComponent as n}from"./react.mjs";var o=(e=>(t="")=>(e.has(t)||e.set(t,new Map),(r,{id:n,rule:o}={})=>r&&!n?e.get(t).get(r):n?(e.get(t).set(r,{id:n,rule:o}),n):e))(new Map),s=(()=>{const e=parseInt("ad",36),t=parseInt("zz",36),r=parseInt("aaa",36);let n=e;return e=>{if(n+=n<t||n>=r?1:r-t,e){const t=parseInt(e,36);return n=t>n?t:n,t.toString(36)}return n.toString(36)}})(),a=e=>e.replace(/[A-Z]/g,"-$&").toLowerCase().replace(/^ms-/,"-ms-"),c=e=>Object.entries(e).reduce((e,[t,r])=>/^(number|string)$/.test(typeof r)?e.concat(`${a(t)}:${r}`):e,[]).join(";"),i=({block:e,id:t,pseudo:r="",ruleset:n,ruletype:o})=>{const a=s(t);return[a,n||(e=>{switch(e){case"font-face":return(e,{block:t})=>((e,t)=>`@font-face{font-family:${e};${t}}`)(e,t);case"keyframes":return(e,{block:t})=>((e,t)=>`@keyframes ${e}{${t}}`)(e,t);default:return(e,{block:t,pseudo:r})=>((e,t)=>`${e}{${t}}`)(((e,t="")=>`.${e}${t}`)(e,r),t)}})(o)(a,{block:e,pseudo:r})]};const u=(t,r="",n="")=>Object.entries(t).reduce((t,[l,d])=>{if(/^\$.*( |>|\+|~)\$.*$/.test(l))((e,t,r)=>{const n=o(r)(e[0]).id,s=e[1],a=o(r)(e[2]).id,i=`.${n}${s}.${a}`,u=`${n}${s}${a}`;o(r)(e.join(""),{id:u,rule:`${i}{${c(t)}}`})})(l.split(/( |>|\+|~)/),d,r);else{if(/^\$(?:(?!( |>|\+|~|\$)).)*$/.test(l))return t.concat(((e,t,r)=>{const n=s();return o(t)(e,{id:`${n}${r}`}),n})(l,r,n));if("object"!=typeof d){const s=`${n}${a(l)}:${d}`;return o(r)(s)?t.concat(o(r)(s)):t.concat(((t,r,n,s="")=>{const c=Object.entries(e({[t]:r})||{}).map(([e,t])=>/^(number|string)$/.test(typeof t)?`${a(e)}:${t}`:Array.isArray(t)?t.map(t=>u({[e]:t},n,s)):void 0).concat(`${a(t)}:${r}`).join(""),[l,d]=i({block:c,pseudo:s});return o(n)(`${s}${c}`,{id:l,rule:d})})(l,d,r,n))}if(":"===l[0])return t.concat(u(d,r,`${n}${l}`));if("@media"===l.substring(0,6))return t.concat(u(d,l.substr(7),n))}return t},[]).join(" ");var l=e=>{const t=(e=>Object.entries(e).reduce((e,[t,r])=>`${e}${t}{${c(r)}}`,""))(e),[r,n]=i({block:t,ruletype:"keyframes"});return o()(t,{id:r,rule:n})};const d=e=>Object.entries(e).reduce((e,[t,r])=>("animationName"===t&&"string"!=typeof r?e.animationName=l(r):"fontFamily"===t&&"string"!=typeof r?e.fontFamily=(e=>{const t=c(e),[r,n]=i({block:t,ruletype:"font-face"});return o()(t,{id:r,rule:n})})(r):"object"==typeof r&&null!==r&&d(r),e),e);var f=e=>u(d(e)),m=(e=!1)=>e?Array.from(o()()).reduce((e,[t,r])=>e.concat(t?`@media ${t}{${Array.from(r.values()).map(({rule:e})=>e).join("")}}`:Array.from(r.values()).map(({rule:e})=>e).join("")),[]).join(""):Array.from(o()()).reduce((e,[t,r])=>({...e,[t]:Array.from(r.values()).map(({rule:e})=>e).join("")}),{}),$=Boolean("undefined"!=typeof window&&window.document&&window.document.createElement);export default class extends n{constructor(e){super(e),$&&(this.nodes=document.head.querySelectorAll("style.rehydrate")),this.state={}}componentDidMount(){const e={"font-face":/@font-face\{font-family:([^;]+)()?;([^}]*?)\}/g,keyframes:/@keyframes ([^{]+)()?\{((?:[^{]+\{[^}]*\})*?)\}/g,"":/\.([^{:]+)(:[^{]+)?{(?:[^}]*;)?([^}]*?)}/g};this.nodes.forEach(t=>{const{media:r,textContent:n}=t;Object.entries(e).reduce((e,[t,n])=>(e.replace(n,(...e)=>{const[n,s,a="",c]=e,[u,l]=i({block:c,id:s,pseudo:a,ruleset:n,ruletype:t});o(r)(`${a}${c}`,{id:u,rule:l})}),e.replace(n,"")),n),t.remove()})}render(){this.setState(m());const{render:e}=this.props,n=Object.entries(m()).map(([e=null,t])=>r("style",{className:"rehydrate",dangerouslySetInnerHTML:{__html:t},media:e||null}));switch(!0){case $:return t(n,document.head);case e:return n;default:return null}}}export{f as css,m as getCss};