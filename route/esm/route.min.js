import{createContext,Component,createElement as h,unstable_deferredUpdates,forwardRef,Children,cloneElement,PureComponent}from"./react.js";const createNamedContext=(e,t)=>{const{Consumer:o,Provider:n}=createContext(t);return o.displayName=`${e}.Consumer`,n.displayName=`${e}.Provider`,{Consumer:o,Provider:n}},BaseContext=createNamedContext("Base",{basepath:"/",baseuri:"/"}),FocusContext=createNamedContext("Focus"),LocationContext=createNamedContext("Location"),getLocation=e=>({...e.location,key:e.history.state&&e.history.state.key||"initial",state:e.history.state}),createHistory=e=>{let t=[],o=getLocation(e),n=!1,r=()=>{};return{_onTransitionComplete(){n=!1,r()},listen(n){t.push(n);const r=()=>{o=getLocation(e),n()};return e.addEventListener("popstate",r),()=>{e.removeEventListener("popstate",r),t=t.filter(e=>e!==n)}},get location(){return o},navigate(s,{state:a,replace:i=!1}={}){a={...a,key:String(Date.now())};try{n||i?e.history.replaceState(a,null,s):e.history.pushState(a,null,s)}catch(t){e.location[i?"replace":"assign"](s)}o=getLocation(e),n=!0;const c=new Promise(e=>{r=e});return t.forEach(e=>e()),c},get transitioning(){return n}}},createMemorySource=(e="/")=>{let t=0;const o=[{pathname:e,search:""}],n=[];return{addEventListener(){},history:{get entries(){return o},get index(){return t},pushState(e,r,s){const[a,i=""]=s.split("?");t++,o.push({pathname:a,search:i}),n.push(e)},replaceState(e,r,s){const[a,i=""]=s.split("?");o[t]={pathname:a,search:i},n[t]=e},get state(){return n[t]}},get location(){return o[t]},removeEventListener(){}}},canUseDOM=Boolean("undefined"!=typeof window&&window.document&&window.document.createElement),getSource=()=>canUseDOM?window:createMemorySource(),globalHistory=createHistory(getSource()),{navigate:navigate}=globalHistory,startsWith=(e,t)=>e.substr(0,t.length)===t,pick=(e,t)=>{let o,n;const[r]=t.split("?"),s=segmentize(r),a=""===s[0],i=rankRoutes(e);for(let e=0,r=i.length;e<r;e++){let r=!1;const c=i[e].route;if(c.default){o={params:{},route:c,uri:t};continue}const u=segmentize(c.path),l={},p=Math.max(s.length,u.length);let h=0;for(;h<p;h++){const e=u[h],t=s[h];if("*"===e){l["*"]=s.slice(h).map(decodeURIComponent).join("/");break}if(void 0===t){r=!0;break}const o=paramRe.exec(e);if(o&&!a){reservedNames.indexOf(o[1]);const e=decodeURIComponent(t);l[o[1]]=e}else if(e!==t){r=!0;break}}if(!r){n={params:l,route:c,uri:`/${s.slice(0,h).join("/")}`};break}}return n||o||null},match=(e,t)=>pick([{path:e}],t),resolve=(e,t)=>{if(startsWith(e,"/"))return e;const[o,n]=e.split("?"),[r]=t.split("?"),s=segmentize(o),a=segmentize(r);if(""===s[0])return addQuery(r,n);if(!startsWith(s[0],".")){const e=a.concat(s).join("/");return addQuery(("/"===r?"":"/")+e,n)}const i=a.concat(s),c=[];for(let e=0,t=i.length;e<t;e++){const t=i[e];".."===t?c.pop():"."!==t&&c.push(t)}return addQuery(`/${c.join("/")}`,n)},insertParams=(e,t)=>{return`/${segmentize(e).map(e=>{const o=paramRe.exec(e);return o?t[o[1]]:e}).join("/")}`},paramRe=/^:(.+)/,SEGMENT_POINTS=4,STATIC_POINTS=3,DYNAMIC_POINTS=2,SPLAT_PENALTY=1,ROOT_POINTS=1,isRootSegment=e=>""===e,isDynamic=e=>paramRe.test(e),isSplat=e=>"*"===e,rankRoute=(e,t)=>{return{index:t,route:e,score:e.default?0:segmentize(e.path).reduce((e,t)=>(e+=4,isRootSegment(t)?e+=1:isDynamic(t)?e+=2:isSplat(t)?e-=5:e+=3,e),0)}},rankRoutes=e=>e.map(rankRoute).sort((e,t)=>e.score<t.score?1:e.score>t.score?-1:e.index-t.index),segmentize=e=>e.replace(/(^\/+|\/+$)/g,"").split("/"),addQuery=(e,t)=>e+(t?`?${t}`:""),reservedNames=["uri","path"];function RedirectRequest(e){this.uri=e}const redirectTo=e=>{throw new RedirectRequest(e)};class RedirectImpl extends Component{componentDidMount(){const{navigate:e,replace:t=!0,state:o,to:n,...r}=this.props;Promise.resolve().then(()=>{e(insertParams(n,r),{replace:t,state:o})})}render(){const{noThrow:e,to:t,...o}=this.props;return e||redirectTo(insertParams(t,o)),null}}const Redirect=e=>h(Location,{},t=>h(RedirectImpl,{...t,...e})),isRedirect=e=>e instanceof RedirectRequest;class LocationProvider extends Component{constructor(e){super(e),this.state={context:this.getContext(),refs:{unlisten:null}}}componentDidMount(){const{history:e}=this.props,{refs:t}=this.state;t.unlisten=e.listen(()=>{Promise.resolve().then(()=>{unstable_deferredUpdates(()=>{this.unmounted||this.setState(()=>({context:this.getContext()}))})})})}componentDidUpdate(e,t){const{history:o}=this.props,{context:n}=this.state;t.context.location!==n.location&&o._onTransitionComplete()}componentDidCatch(e){if(!isRedirect(e))throw new Error(e);{const{navigate:t}=this.props.history;t(e.uri,{replace:!0})}}componentWillUnmount(){const{refs:e}=this.state;this.unmounted=!0,e.unlisten()}getContext(){const{location:e,navigate:t}=this.props.history;return{location:e,navigate:t}}render(){const{children:e}=this.props,{context:t}=this.state;return h(LocationContext.Provider,{value:t},"function"==typeof e?e(t):e||null)}}LocationProvider.defaultProps={history:globalHistory};const Location$1=({children:e})=>h(LocationContext.Consumer,{},t=>t?e(t):h(LocationProvider,{},e)),ServerLocation=({children:e,url:t})=>h(LocationContext.Provider,{value:{location:{pathname:t},navigate:()=>{throw new Error("You can't call navigate on the server.")}}},e),shouldNavigate=e=>!e.defaultPrevented&&0===e.button&&!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey),Link=forwardRef(({innerRef:e,...t},o)=>h(BaseContext.Consumer,{},({baseuri:n})=>h(Location$1,{},({location:r,navigate:s})=>{const{getProps:a=(()=>{}),replace:i,state:c,to:u,...l}=t,p=resolve(u,n),d=r.pathname===p,m=startsWith(r.pathname,p);return h("a",{...a({href:p,isCurrent:d,isPartiallyCurrent:m,location:r}),...l,"aria-current":d?"page":null,href:p,onClick:e=>{l.onClick&&l.onClick(e),shouldNavigate(e)&&(e.preventDefault(),s(p,{replace:i,state:c}))},ref:o||e})}))),Match=({children:e,path:t})=>h(BaseContext.Consumer,{},({baseuri:o})=>h(Location,{},({location:n,navigate:r})=>{const s=resolve(t,o),a=match(s,n.pathname);return e({location:n,match:a?{...a.params,path:t,uri:a.uri}:null,navigate:r})}));class FocusHandlerImpl extends Component{constructor(e){super(e),this.state={initialRender:!0},this.requestFocus=(e=>{const{shouldFocus:t}=this.state;t||e.focus()})}static getDerivedStateFromProps({location:e,uri:t,...o},n){if(void 0===n.uri)return{shouldFocus:!0,...o};const r=t!==n.uri,s=e.pathname===t&&n.location.pathname!==e.pathname;return{shouldFocus:r||s,...o}}componentDidMount(){this.setState(e=>({...e,focusHandlerCount:e.focusHandlerCount+1})),this.focus()}componentDidUpdate(e){const{location:t}=this.props,{shouldFocus:o}=this.state;e.location!==t&&o&&this.focus()}componentWillUnmount(){this.setState(e=>({...e,focusHandlerCount:e.focusHandlerCount-1,initialRender:1===e.focusHandlerCount||e.initialRender}))}focus(){const{requestFocus:e}=this.props,{initialRender:t}=this.state;e?e(this.node):t?this.setState({initialRender:!1}):this.node.focus()}render(){const{children:e,component:t="div",role:o="group",style:n,...r}=this.props;return["location","requestFocus","uri"].forEach(e=>delete r[e]),h(t,{ref:e=>{this.node=e},role:o,style:{outline:"none",...n},tabIndex:"-1",...r},h(FocusContext.Provider,{value:this.requestFocus},e))}}const FocusHandler=e=>h(FocusContext.Consumer,{},t=>h(FocusHandlerImpl,{...e,requestFocus:t})),stripSlashes=e=>e.replace(/(^\/+|\/+$)/g,""),createRoute=e=>t=>{if(t.props.default)return{default:!0,value:t};const o=t.type===Redirect?t.props.from:t.props.path,n="/"===o?e:`${stripSlashes(e)}/${stripSlashes(o)}`;return{default:t.props.default,path:t.props.children?`${stripSlashes(n)}/*`:n,value:t}};class RouterImpl extends PureComponent{render(){const{children:e,component:t="div",location:o,navigate:n,primary:r,...s}=this.props;let{basepath:a}=this.props;const i=Children.map(e,createRoute(a)),{pathname:c}=o,u=pick(i,c);if(u){const{params:e,route:i,route:{value:c},uri:l}=u;a=i.default?a:i.path.replace(/\*$/,"");const p=r?FocusHandler:t,d=r?{component:t,location:o,uri:l,...s}:s,m={...e,location:o,navigate:(e,t)=>n(resolve(e,l),t),uri:l},f=cloneElement(c,m,c.props.children?h(Router,{primary:r},c.props.children):null);return h(BaseContext.Provider,{value:{basepath:a,baseuri:l}},h(p,d,f))}return null}}RouterImpl.defaultProps={primary:!0};const Router=e=>h(BaseContext.Consumer,{},t=>h(Location$1,{},o=>h(RouterImpl,{...t,...o,...e})));export{Link,isRedirect,Location$1 as Location,LocationProvider,ServerLocation,Match,Redirect,redirectTo,Router,createHistory,createMemorySource,navigate};
