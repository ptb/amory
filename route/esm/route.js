import{createContext,Component,createElement as h,unstable_deferredUpdates,forwardRef,Children,cloneElement,PureComponent}from"./react.js";const createNamedContext=(e,t)=>{const{Consumer:n,Provider:r}=createContext(t);return n.displayName=`${e}.Consumer`,r.displayName=`${e}.Provider`,{Consumer:n,Provider:r}},BaseContext=createNamedContext("Base",{basepath:"/",baseuri:"/"}),FocusContext=createNamedContext("Focus"),LocationContext=createNamedContext("Location");var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},getLocation=function(e){return _extends({},e.location,{state:e.history.state,key:e.history.state&&e.history.state.key||"initial"})},createHistory=function(e,t){var n=[],r=getLocation(e),o=!1,a=function(){};return{get location(){return r},get transitioning(){return o},_onTransitionComplete:function(){o=!1,a()},listen:function(t){n.push(t);var o=function(){r=getLocation(e),t()};return e.addEventListener("popstate",o),function(){e.removeEventListener("popstate",o),n=n.filter(function(e){return e!==t})}},navigate:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=i.state,c=i.replace,u=void 0!==c&&c;s=_extends({},s,{key:Date.now()+""});try{o||u?e.history.replaceState(s,null,t):e.history.pushState(s,null,t)}catch(n){e.location[u?"replace":"assign"](t)}r=getLocation(e),o=!0;var l=new Promise(function(e){return a=e});return n.forEach(function(e){return e()}),l}}},createMemorySource=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",t=0,n=[{pathname:e,search:""}],r=[];return{get location(){return n[t]},addEventListener:function(e,t){},removeEventListener:function(e,t){},history:{get entries(){return n},get index(){return t},get state(){return r[t]},pushState:function(e,o,a){var i=a.split("?"),s=i[0],c=i[1],u=void 0===c?"":c;t++,n.push({pathname:s,search:u}),r.push(e)},replaceState:function(e,o,a){var i=a.split("?"),s=i[0],c=i[1],u=void 0===c?"":c;n[t]={pathname:s,search:u},r[t]=e}}}},canUseDOM=!("undefined"==typeof window||!window.document||!window.document.createElement),getSource=function(){return canUseDOM?window:createMemorySource()},globalHistory=createHistory(getSource()),navigate=globalHistory.navigate;let startsWith=function(e,t){return e.substr(0,t.length)===t},pick=function(e,t){let n=void 0;var r=void 0,o=t.split("?")[0],a=segmentize(o),i=""===a[0],s=rankRoutes(e);for(let e=0,o=s.length;e<o;e++){let o=!1;var c=s[e].route;if(c.default){r={route:c,params:{},uri:t};continue}let m=segmentize(c.path);for(var u={},l=Math.max(a.length,m.length),p=0;p<l;p++){let e=m[p];var d=a[p];if("*"===e){u["*"]=a.slice(p).map(decodeURIComponent).join("/");break}if(void 0===d){o=!0;break}let t=paramRe.exec(e);if(t&&!i){reservedNames.indexOf(t[1]);var h=decodeURIComponent(d);u[t[1]]=h}else if(e!==d){o=!0;break}}if(!o){n={route:c,params:u,uri:`/${a.slice(0,p).join("/")}`};break}}return n||r||null},match=function(e,t){return pick([{path:e}],t)},resolve=function(e,t){if(startsWith(e,"/"))return e;let n=e.split("?");var r=n[0],o=n[1],a=t.split("?")[0],i=segmentize(r),s=segmentize(a);if(""===i[0])return addQuery(a,o);if(!startsWith(i[0],".")){let e=s.concat(i).join("/");return addQuery(("/"===a?"":"/")+e,o)}let c=s.concat(i);var u=[];for(let e=0,t=c.length;e<t;e++){let t=c[e];".."===t?u.pop():"."!==t&&u.push(t)}return addQuery(`/${u.join("/")}`,o)},insertParams=function(e,t){return`/${segmentize(e).map(function(e){var n=paramRe.exec(e);return n?t[n[1]]:e}).join("/")}`};var paramRe=/^:(.+)/,SEGMENT_POINTS=4,STATIC_POINTS=3,DYNAMIC_POINTS=2,SPLAT_PENALTY=1,ROOT_POINTS=1,isRootSegment=function(e){return""===e},isDynamic=function(e){return paramRe.test(e)};let isSplat=function(e){return"*"===e},rankRoute=function(e,t){return{route:e,score:e.default?0:segmentize(e.path).reduce(function(e,t){return e+=SEGMENT_POINTS,isRootSegment(t)?e+=ROOT_POINTS:isDynamic(t)?e+=DYNAMIC_POINTS:isSplat(t)?e-=SEGMENT_POINTS+SPLAT_PENALTY:e+=STATIC_POINTS,e},0),index:t}};var rankRoutes=function(e){return e.map(rankRoute).sort(function(e,t){return e.score<t.score?1:e.score>t.score?-1:e.index-t.index})},segmentize=function(e){return e.replace(/(^\/+|\/+$)/g,"").split("/")},addQuery=function(e,t){return e+(t?`?${t}`:"")},reservedNames=["uri","path"];function RedirectRequest(e){this.uri=e}const redirectTo=e=>{throw new RedirectRequest(e)};class RedirectImpl extends Component{componentDidMount(){const{navigate:e,replace:t=!0,state:n,to:r,...o}=this.props;Promise.resolve().then(()=>{e(insertParams(r,o),{replace:t,state:n})})}render(){const{noThrow:e,to:t,...n}=this.props;return e||redirectTo(insertParams(t,n)),null}}const Redirect=e=>h(Location,{},t=>h(RedirectImpl,{...t,...e})),isRedirect=e=>e instanceof RedirectRequest;class LocationProvider extends Component{constructor(e){super(e),this.state={context:this.getContext(),refs:{unlisten:null}}}componentDidMount(){const{history:e}=this.props,{refs:t}=this.state;t.unlisten=e.listen(()=>{Promise.resolve().then(()=>{unstable_deferredUpdates(()=>{this.unmounted||this.setState(()=>({context:this.getContext()}))})})})}componentDidUpdate(e,t){const{history:n}=this.props,{context:r}=this.state;t.context.location!==r.location&&n._onTransitionComplete()}componentDidCatch(e){if(!isRedirect(e))throw new Error(e);{const{navigate:t}=this.props.history;t(e.uri,{replace:!0})}}componentWillUnmount(){const{refs:e}=this.state;this.unmounted=!0,e.unlisten()}getContext(){const{location:e,navigate:t}=this.props.history;return{location:e,navigate:t}}render(){const{children:e}=this.props,{context:t}=this.state;return h(LocationContext.Provider,{value:t},"function"==typeof e?e(t):e||null)}}LocationProvider.defaultProps={history:globalHistory};const Location$1=({children:e})=>h(LocationContext.Consumer,{},t=>t?e(t):h(LocationProvider,{},e)),ServerLocation=({children:e,url:t})=>h(LocationContext.Provider,{value:{location:{pathname:t},navigate:()=>{throw new Error("You can't call navigate on the server.")}}},e),shouldNavigate=e=>!e.defaultPrevented&&0===e.button&&!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey),Link=forwardRef(({innerRef:e,...t},n)=>h(BaseContext.Consumer,{},({baseuri:r})=>h(Location$1,{},({location:o,navigate:a})=>{const{getProps:i=(()=>{}),replace:s,state:c,to:u,...l}=t,p=resolve(u,r),d=o.pathname===p,h=startsWith(o.pathname,p);return h("a",{...i({href:p,isCurrent:d,isPartiallyCurrent:h,location:o}),...l,"aria-current":d?"page":null,href:p,onClick:e=>{l.onClick&&l.onClick(e),shouldNavigate(e)&&(e.preventDefault(),a(p,{replace:s,state:c}))},ref:n||e})}))),Match=({children:e,path:t})=>h(BaseContext.Consumer,{},({baseuri:n})=>h(Location,{},({location:r,navigate:o})=>{const a=resolve(t,n),i=match(a,r.pathname);return e({location:r,match:i?{...i.params,path:t,uri:i.uri}:null,navigate:o})}));class FocusHandlerImpl extends Component{constructor(e){super(e),this.state={initialRender:!0},this.requestFocus=(e=>{const{shouldFocus:t}=this.state;t||e.focus()})}static getDerivedStateFromProps({location:e,uri:t,...n},r){if(void 0===r.uri)return{shouldFocus:!0,...n};const o=t!==r.uri,a=e.pathname===t&&r.location.pathname!==e.pathname;return{shouldFocus:o||a,...n}}componentDidMount(){this.setState(e=>({...e,focusHandlerCount:e.focusHandlerCount+1})),this.focus()}componentDidUpdate(e){const{location:t}=this.props,{shouldFocus:n}=this.state;e.location!==t&&n&&this.focus()}componentWillUnmount(){this.setState(e=>({...e,focusHandlerCount:e.focusHandlerCount-1,initialRender:1===e.focusHandlerCount||e.initialRender}))}focus(){const{requestFocus:e}=this.props,{initialRender:t}=this.state;e?e(this.node):t?this.setState({initialRender:!1}):this.node.focus()}render(){const{children:e,component:t="div",role:n="group",style:r,...o}=this.props;return["location","requestFocus","uri"].forEach(e=>delete o[e]),h(t,{ref:e=>{this.node=e},role:n,style:{outline:"none",...r},tabIndex:"-1",...o},h(FocusContext.Provider,{value:this.requestFocus},e))}}const FocusHandler=e=>h(FocusContext.Consumer,{},t=>h(FocusHandlerImpl,{...e,requestFocus:t})),stripSlashes=e=>e.replace(/(^\/+|\/+$)/g,""),createRoute=e=>t=>{if(t.props.default)return{default:!0,value:t};const n=t.type===Redirect?t.props.from:t.props.path,r="/"===n?e:`${stripSlashes(e)}/${stripSlashes(n)}`;return{default:t.props.default,path:t.props.children?`${stripSlashes(r)}/*`:r,value:t}};class RouterImpl extends PureComponent{render(){const{children:e,component:t="div",location:n,navigate:r,primary:o,...a}=this.props;let{basepath:i}=this.props;const s=Children.map(e,createRoute(i)),{pathname:c}=n,u=pick(s,c);if(u){const{params:e,route:s,route:{value:c},uri:l}=u;i=s.default?i:s.path.replace(/\*$/,"");const p=o?FocusHandler:t,d=o?{component:t,location:n,uri:l,...a}:a,h={...e,location:n,navigate:(e,t)=>r(resolve(e,l),t),uri:l},m=cloneElement(c,h,c.props.children?h(Router,{primary:o},c.props.children):null);return h(BaseContext.Provider,{value:{basepath:i,baseuri:l}},h(p,d,m))}return null}}RouterImpl.defaultProps={primary:!0};const Router=e=>h(BaseContext.Consumer,{},t=>h(Location$1,{},n=>h(RouterImpl,{...t,...n,...e})));export{Link,isRedirect,Location$1 as Location,LocationProvider,ServerLocation,Match,Redirect,redirectTo,Router,createHistory,createMemorySource,navigate};
